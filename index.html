<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدخال بيانات PDF و مديونية/إيداع — نسخة مدمجة</title>
<style>
body { font-family:"Segoe UI", Tahoma, sans-serif; direction:rtl; text-align:center; background:#f5f5f5; padding:18px 0 ;margin: 0; }
h2 { margin: 8px 0 18px; }
.box, .box3 { background:#fff; padding:12px 0 ; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,.08); margin:10px auto; width:99%;  }
input, button { padding:8px; margin:6px 6px 6px 0; border-radius:6px; border:1px solid #ccc; }
button { background:#0078d7; color:#fff; border:0; cursor:pointer; }
button.red:hover { background:#d9534f; }
.secondary:hover { background-color:#d9534f;  }
table { width:100%; margin:18px auto; border-collapse:collapse; background:#fff; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#0078d7; color:#fff; }
.action-btn { padding:4px 6px; margin:0 3px; border-radius:4px; border:0; cursor:pointer; }
.edit-btn, .editBtn { background:orange; color:#fff; }
.editBtn:hover { background:#009688; color:#fff; }
.edit-btn:hover { background:#009688; }
.delete-btn, .deleteBtn { background:orange; color:#fff; }
.delete-btn:hover, .deleteBtn:hover { background:red; }
tfoot td { background:#eee; font-weight:bold; }
.info { text-align:left; max-width:980px; margin:6px auto; color:#333; }
.small { font-size:0.9rem; color:#555; }

.form-row { display:flex; flex-wrap:nowrap; align-items:flex-end; justify-content:center; gap:10px; overflow-x:auto; }
.form-group { display:flex; flex-direction:column; min-width:120px; }
.form-group label { font-size:1.5rem; margin-bottom:4px; color:#333; }
.form-group input { font-size:1.2rem; padding:6px 8px; border-radius:6px; border:1px solid #ccc; width:175px; box-sizing:border-box; }
.form-row button { padding:8px 12px; border-radius:6px; border:none; background:#0078d7; color:#fff; cursor:pointer; font-size:17px; }
#updateBtn{ display:none; background:#F44336; color:#fff; height:38px; }
#updateBtn:hover{ background:#0078d7; }

@media (max-width: 768px) {
  .form-row { flex-wrap: wrap; justify-content: flex-start; }
  .form-group { flex:1 1 45%; min-width:auto; }
  .form-group input { width:100%; }
  .form-row button { flex:1 1 100%; margin-top:8px; }
}

/* مديونية */
.box3 input { width:180px; font-size:17px; }
.box3 button { font-size:17px; }
tfoot #finalTotal { text-align:center; }
.editBox { margin-top:25px; padding:15px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9; display:none; font-size:17px; }

/* تعديل: توحيد عرض كل الحاويات */
.full-width-container { width:99%; margin:10px auto; }
</style>
</head>
<body>

<h2> إدخال بيانات PDF📄 </h2>
<div class="box">
  <form id="dataForm" onsubmit="return false;" class="form-row">
    <div class="form-group">
      <label for="date">التاريخ</label>
      <input type="text" id="date" placeholder="اليوم-الشهر-السنة" maxlength="10">
    </div>
    <div class="form-group"><label for="tractor">رقم الجرار</label><input type="text" id="tractor" placeholder="رقم الجرار" required></div>
    <div class="form-group"><label for="trailer">رقم المقطوره</label><input type="text" id="trailer" placeholder="رقم المقطوره" required></div>
    <div class="form-group"><label for="bon">رقم البون</label><input type="text" id="bon" placeholder="رقم البون" required></div>
    <div class="form-group"><label for="material">الخامة</label><input type="text" id="material" placeholder="الخامة" required></div>
    <div class="form-group"><label for="volume">التكعيب</label><input type="number" id="volume" placeholder="التكعيب" step="0.01" required></div>
    <div class="form-group"><label for="price">سعر المتر</label><input type="number" id="price" placeholder="سعر المتر" step="0.01" required></div>

    <button id="addBtn" onclick="onSubmitForm()">➕ إضافة</button>
    <button id="updateBtn" onclick="onUpdateForm()">✅ تعديل</button>
  </form>
</div>

<!-- اختيار الملف PDF -->
<div class="box full-width-container">
  <div style="margin-bottom:8px;">
    <input type="file" id="pdfInput" accept="application/pdf" />
    <button onclick="readPDF()">📥 إدخال من PDF</button>
    <button class="secondary" onclick="clearFile()">❌ مسح اختيار الملف</button>
  </div>
  <div class="info small" id="parseInfo"></div>
</div>

<!-- جدول PDF -->
<div class="full-width-container">
<table id="dataTable">
  <thead>
    <tr>
      <th>م</th>
      <th>التاريخ</th>
      <th>رقم الجرار</th>
      <th>رقم المقطوره</th>
      <th>رقم البون</th>
      <th>الخامة</th>
      <th>التكعيب</th>
      <th>سعر المتر</th>
      <th>إجمالي سعر المتر</th>
      <th>عمليات</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="6">الإجمالي</td>
      <td id="totalVolume">0</td>
      <td>-</td>
      <td id="grandTotal">0</td>
      <td><button class="red" onclick="deleteAll()">🗑️ حذف الجميع</button></td>
    </tr>
  </tfoot>
</table>
</div>


<div class="box3 full-width-container">
  <div>
    <input type="number" id="amountInput" placeholder="المبلغ" step="0.01">
    <input type="text" id="dateInput" placeholder="اليوم-الشهر-السنة" maxlength="10">
    <button class="debtBtn" onclick="addDebtOrDeposit('debt')">➕ مديونية</button>
    <button class="depositBtn" onclick="addDebtOrDeposit('deposit')">➕ إيداع</button>
  </div>

  <table id="debtDepositTable">
    <thead><tr><th>التفاصيل</th><th>المبلغ</th><th>عمليات</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><td style="text-align:center;">الإجمالي النهائي</td><td id="finalTotal">0.00</td><td></td></tr></tfoot>
  </table>

  <div class="editBox" id="editBox">
    <h3 style="font-size:20px;">✏️ تعديل الصف</h3>
    <input type="number" id="editAmount" placeholder="المبلغ" step="0.01">
    <input type="text" id="editDate" placeholder="اليوم-الشهر-السنة" maxlength="10">
    <br>
    <button onclick="saveEdit()">حفظ التعديل</button>
    <button onclick="cancelEdit()">إلغاء</button>
  </div>
</div>
<div style="margin:12px auto; text-align:center;">
  <button onclick="printData()">🖨️ طباعة البيانات</button>
  <button onclick="copyData()">📋 نسخ البيانات</button>
  <button onclick="exportExcel()">📊 حفظ كـ Excel</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>

<script>
  /* === وظائف الطباعة / النسخ / Excel بدون أزرار التعديل والحذف === */
function cleanTableForExport(tableId){
  const clone = document.getElementById(tableId).cloneNode(true);
  clone.querySelectorAll("button").forEach(b=>b.remove());
  return clone;
}

function printData(){
  const tablePDF = cleanTableForExport("dataTable");
  const tableDebt = cleanTableForExport("debtDepositTable");
  const newWin = window.open("");
  newWin.document.write(`<html><head><title>طباعة البيانات</title>
  <style>
    body{font-family:"Segoe UI",Tahoma,sans-serif;direction:rtl;text-align:center;}
    table{width:100%;border-collapse:collapse;margin:20px 0;}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;}
    th{background:#0078d7;color:#fff;}
  </style></head><body>
  <h2>إدخال بيانات PDF📄</h2>${tablePDF.outerHTML}
  <h2>المديونية والإيداعات</h2>${tableDebt.outerHTML}
  </body></html>`);
  newWin.document.close();
  newWin.print();
}

function copyData(){
  const tablePDF = cleanTableForExport("dataTable");
  const tableDebt = cleanTableForExport("debtDepositTable");
  const textToCopy = tablePDF.innerText + "\n\n" + tableDebt.innerText;
  navigator.clipboard.writeText(textToCopy).then(()=>alert("تم نسخ البيانات ✅"));
}

function exportExcel(){
  const wb = XLSX.utils.book_new();
  const tablePDF = cleanTableForExport("dataTable");
  const ws1 = XLSX.utils.table_to_sheet(tablePDF);
  XLSX.utils.book_append_sheet(wb, ws1, "بيانات PDF");
  const tableDebt = cleanTableForExport("debtDepositTable");
  const ws2 = XLSX.utils.table_to_sheet(tableDebt);
  XLSX.utils.book_append_sheet(wb, ws2, "مديونية/إيداع");
  XLSX.writeFile(wb, "بيانات_PDF.xlsx");
}
/* === دوال التاريخ المشتركة === */
function padDate(input){ const parts=input.split('-'); if(parts.length!==3) return input; let [day, month, year]=parts; day=String(day).padStart(2,'0'); month=String(month).padStart(2,'0'); return `${day}-${month}-${year}`; }
function formatDate(input){ const parts=input.split('-'); if(parts.length!==3) return input; let [day, month, year]=parts; day=String(day).padStart(2,'0'); month=String(month).padStart(2,'0'); return `${year}-${month}-${day}`; }
function formatDateReverse(input){ const parts=input.split('-'); if(parts.length!==3) return input; let [year, month, day]=parts; day=String(day).padStart(2,'0'); month=String(month).padStart(2,'0'); return `${year}-${month}-${day}`; }

/* === بيانات PDF === */
let editRowIndex = null;
function parseNumberFromString(s){ if(!s) return NaN; const m=s.match(/-?\d[\d\.,]*/); if(!m) return NaN; return Number(m[0].replace(/,/g,'.')); }
function onSubmitForm(){ const dateRaw=document.getElementById("date").value; const date=formatDate(dateRaw); const tractor=document.getElementById("tractor").value.trim(); const trailer=document.getElementById("trailer").value.trim(); const bon=document.getElementById("bon").value.trim(); const material=document.getElementById("material").value.trim(); const volume=parseFloat(document.getElementById("volume").value); const price=parseFloat(document.getElementById("price").value); if(editRowIndex!==null){ updateRow(editRowIndex,date,tractor,trailer,bon,material,volume,price); editRowIndex=null; document.getElementById("dataForm").reset(); document.getElementById("addBtn").style.display="inline-block"; document.getElementById("updateBtn").style.display="none"; return; } addRow(date,tractor,trailer,bon,material,volume,price); document.getElementById("dataForm").reset(); }
function addRow(date,tractor,trailer,bon,material,volume,price){ if(!date||!tractor||!trailer||!bon||!material||isNaN(volume)||isNaN(price)){ alert("تأكد من تعبئة كل الحقول يدوياً بشكل صحيح."); return; } const tbody=document.querySelector("#dataTable tbody"); const tr=tbody.insertRow(); const total=(volume*price).toFixed(2); tr.innerHTML=`<td></td><td>${date}</td><td>${tractor}</td><td>${trailer}</td><td>${bon}</td><td>${material}</td><td>${volume}</td><td>${price}</td><td>${total}</td><td><button class="action-btn edit-btn" onclick="editRowFuncPDF(this)">✏️</button><button class="action-btn delete-btn" onclick="deleteRowPDF(this)">🗑️</button></td>`; updateIndexesPDF(); updateTotalsPDF(); }
function editRowFuncPDF(button){ const row=button.parentElement.parentElement; const tbody=document.querySelector("#dataTable tbody"); editRowIndex=Array.from(tbody.rows).indexOf(row); document.getElementById("date").value=row.cells[1].innerText; document.getElementById("tractor").value=row.cells[2].innerText; document.getElementById("trailer").value=row.cells[3].innerText; document.getElementById("bon").value=row.cells[4].innerText; document.getElementById("material").value=row.cells[5].innerText; document.getElementById("volume").value=row.cells[6].innerText; document.getElementById("price").value=row.cells[7].innerText; document.getElementById("addBtn").style.display="none"; document.getElementById("updateBtn").style.display="inline-block"; window.scrollTo({top:0,behavior:'smooth'}); }
function onUpdateForm(){ if(editRowIndex===null) return; const date=document.getElementById("date").value; const tractor=document.getElementById("tractor").value.trim(); const trailer=document.getElementById("trailer").value.trim(); const bon=document.getElementById("bon").value.trim(); const material=document.getElementById("material").value.trim(); const volume=parseFloat(document.getElementById("volume").value); const price=parseFloat(document.getElementById("price").value); updateRow(editRowIndex,date,tractor,trailer,bon,material,volume,price); document.getElementById("dataForm").reset(); document.getElementById("addBtn").style.display="inline-block"; document.getElementById("updateBtn").style.display="none"; editRowIndex=null; }
function updateRow(index,date,tractor,trailer,bon,material,volume,price){ const tbody=document.querySelector("#dataTable tbody"); const row=tbody.rows[index]; if(!row) return; const total=(volume*price).toFixed(2); row.cells[1].innerText=date; row.cells[2].innerText=tractor; row.cells[3].innerText=trailer; row.cells[4].innerText=bon; row.cells[5].innerText=material; row.cells[6].innerText=volume; row.cells[7].innerText=price; row.cells[8].innerText=total; updateTotalsPDF(); }
function deleteRowPDF(button){ button.parentElement.parentElement.remove(); updateIndexesPDF(); updateTotalsPDF(); }
function deleteAll(){ document.querySelector("#dataTable tbody").innerHTML=""; updateIndexesPDF(); updateTotalsPDF(); }
function updateIndexesPDF(){ const rows=document.querySelectorAll("#dataTable tbody tr"); rows.forEach((r,i)=>r.cells[0].innerText=i+1); }
function updateTotalsPDF(){ const rows=document.querySelectorAll("#dataTable tbody tr"); let totalVolume=0, grandTotal=0; rows.forEach(r=>{ totalVolume+=parseFloat(r.cells[6].innerText)||0; grandTotal+=parseFloat(r.cells[8].innerText)||0; }); document.getElementById("totalVolume").innerText=totalVolume.toFixed(2); document.getElementById("grandTotal").innerText=grandTotal.toFixed(2); updateFinalTotal(); }

/* === قراءة PDF === */
async function readPDF(){ const input=document.getElementById("pdfInput"); const file=input.files[0]; if(!file){ alert("اختر ملف PDF أولاً"); return; } document.getElementById("parseInfo").innerText="جاري قراءة الملف ..."; const reader=new FileReader(); reader.onload=async function(){ const typed=new Uint8Array(this.result); const pdf=await pdfjsLib.getDocument(typed).promise; let added=0, skipped=0; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const textContent=await page.getTextContent(); const items=textContent.items.map(it=>{ const t=it.transform||[1,0,0,1,0,0]; return { text:(it.str||"").trim(), x:t[4], y:t[5] }; }).filter(i=>i.text.length>0); if(items.length===0) continue; items.sort((a,b)=>{ if(Math.abs(b.y-a.y)>0.5) return b.y-a.y; return b.x-a.x; }); const rows=[]; const tolerance=4; items.forEach(it=>{ if(rows.length===0) rows.push({y:it.y, items:[it]}); else{ const last=rows[rows.length-1]; if(Math.abs(last.y-it.y)<=tolerance){ last.items.push(it); last.y=(last.y*(last.items.length-1)+it.y)/last.items.length; }else rows.push({y:it.y, items:[it]}); } }); rows.forEach(row=>row.items.sort((a,b)=>b.x-a.x)); for(const row of rows){ const texts=row.items.map(it=>it.text); if(texts.length<2){ skipped++; continue; } const nodes=texts.map(t=>({raw:t,num:parseNumberFromString(t)})); let idxTotal=-1, idxPrice=-1, idxVolume=-1; for(let k=nodes.length-1;k>=0;k--){ if(idxTotal===-1 && Number.isFinite(nodes[k].num)){ idxTotal=k; continue; } if(idxTotal!==-1 && idxPrice===-1 && Number.isFinite(nodes[k].num)){ idxPrice=k; continue; } if(idxPrice!==-1 && idxVolume===-1 && Number.isFinite(nodes[k].num)){ idxVolume=k; break; } } if(idxPrice===-1 || idxVolume===-1){ const numericIndices=nodes.map((n,i)=>Number.isFinite(n.num)?i:-1).filter(i=>i>=0); if(numericIndices.length>=2){ idxPrice=numericIndices[numericIndices.length-1]; idxVolume=numericIndices[numericIndices.length-2]; idxTotal=numericIndices[numericIndices.length-1]; }else{ skipped++; continue; } } const priceVal=nodes[idxPrice].num; const volumeVal=nodes[idxVolume].num; if(!Number.isFinite(priceVal)||!Number.isFinite(volumeVal)){ skipped++; continue; } const serial=nodes[0].raw; const date=nodes[1]?formatDateReverse(nodes[1].raw):""; const middle=nodes.slice(2, idxVolume); if(middle.length<3){ skipped++; continue; } const tractor=middle[0].raw||""; const trailer=middle[1]?middle[1].raw:""; const bon=middle[2]?middle[2].raw:""; const materialParts=middle.slice(3).map(n=>n.raw).filter(Boolean); const material=materialParts.join(" ")||(middle[2]&&middle[2].raw)||""; addRow(date, tractor, trailer, bon, material, volumeVal, priceVal); added++; } } document.getElementById("parseInfo").innerText=`تمت المعالجة: تم إضافة ${added} صف — تم تجاهل ${skipped} سطر.`; }; reader.readAsArrayBuffer(file); }
function clearFile(){ document.getElementById("pdfInput").value=""; document.getElementById("parseInfo").innerText=""; alert("تم مسح اختيار الملف ✅"); }

/* === مديونية وإيداع محسّن === */
let editRow = null, editType='';
function addDebtOrDeposit(type){ const amountInput=document.getElementById("amountInput"); const dateInput=document.getElementById("dateInput"); let amount=parseFloat(amountInput.value); let date=dateInput.value.trim(); if(isNaN(amount)||!date){ alert("يرجى إدخال المبلغ والتاريخ بشكل صحيح!"); return; } date=padDate(date); const tbody=document.querySelector("#debtDepositTable tbody"); const tr=document.createElement("tr"); let details=type==='debt'?`مديونية على العميل من المستخلص السابق بتاريخ ${date}`:`دفعه تحويل بنكي بتاريخ ${date}`; tr.innerHTML=`<td>${details}</td><td>${amount.toFixed(2)}</td><td><button class="editBtn" onclick="editRowFunc(this,'${type}')">✏️</button><button class="deleteBtn" onclick="deleteRowDebt(this)">🗑️</button></td>`; tbody.appendChild(tr); amountInput.value=''; dateInput.value=''; updateFinalTotal(); }
function updateFinalTotal(){ let totalDebt=0, totalDeposit=0; document.querySelectorAll("#debtDepositTable tbody tr").forEach(row=>{ const value=parseFloat(row.cells[1].innerText)||0; const detailsText=row.cells[0].innerText; if(detailsText.includes("مديونية")) totalDebt+=value; else totalDeposit+=value; }); const grandTotal=parseFloat(document.getElementById("grandTotal").innerText)||0; document.getElementById("finalTotal").innerText=(grandTotal + totalDebt - totalDeposit).toFixed(2); }
function deleteRowDebt(button){ button.parentElement.parentElement.remove(); updateFinalTotal(); }
function editRowFunc(button,type){ editRow=button.parentElement.parentElement; editType=type; const amount=editRow.cells[1].innerText; const details=editRow.cells[0].innerText; let extractedDate=details.match(/\d{1,2}-\d{1,2}-\d{4}/); extractedDate=extractedDate?extractedDate[0]:''; document.getElementById("editAmount").value=amount; document.getElementById("editDate").value=extractedDate; document.getElementById("editBox").style.display='block'; }
function saveEdit(){ if(!editRow) return; let amount=parseFloat(document.getElementById("editAmount").value); let date=document.getElementById("editDate").value.trim(); if(isNaN(amount)||!date){ alert("يرجى إدخال المبلغ والتاريخ بشكل صحيح!"); return; } date=padDate(date); editRow.cells[1].innerText=amount.toFixed(2); let detailsText=editRow.cells[0].innerText; detailsText=detailsText.replace(/\d{2}-\d{2}-\d{4}/,date); editRow.cells[0].innerText=detailsText; updateFinalTotal(); cancelEdit(); }
function cancelEdit(){ editRow=null; editType=''; document.getElementById("editBox").style.display='none'; }
</script>

</body>
</html>
